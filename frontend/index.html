<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Список квартир</title>
  <style>
    :root{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; color:#111}
    body{margin:0;padding:24px;background:#f6f8fa}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    button{background:#0366d6;color:white;border:0;padding:6px 12px;border-radius:8px;cursor:pointer}
    button:disabled{opacity:.6;cursor:default}
    .filters, .create-form{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    input[type="text"], input[type="number"], select{padding:6px;border-radius:6px;border:1px solid #ddd}
    table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #f0f0f0}
    th{background:#fafbfc;font-weight:600}
    tr:hover td{background:#fbfdff}
    .center{text-align:center}
    .empty{padding:28px;text-align:center;color:#666}
    .small{font-size:13px;padding:4px 8px;border-radius:6px;border:1px solid #eee}
    .deleteBtn{background:#d9534f;color:white;padding:4px 8px;border-radius:6px;border:0;cursor:pointer}
    .deleteBtn:disabled{opacity:.6;cursor:default}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Список квартир</h1>
      <button id="refreshBtn">Обновить</button>
    </header>

    <!-- Форма создания новой квартиры -->
    <div class="create-form">
      <input id="newType" type="text" placeholder="Тип (appartment/house)" />
      <input id="newRooms" type="number" placeholder="Кол-во комнат" min="0" />
      <input id="newArea" type="number" placeholder="Площадь (м²)" step="0.1" min="0" />
      <input id="newFloor" type="number" placeholder="Этаж" min="0" />
      <input id="newImprovement" type="text" placeholder="Отделка" />
      <input id="newAddress" type="text" placeholder="Адрес" />
      <button id="createBtn">Создать</button>
    </div>

    <div class="filters">
      <input id="filterRooms" type="number" placeholder="Кол-во комнат" min="0" />
      <input id="filterFloor" type="number" placeholder="Этаж" min="0" />
      <input id="filterArea" type="number" placeholder="Площадь (м²)" step="0.1" min="0" />
      <select id="filterType" class="small">
        <option value="">Все типы</option>
        <option value="appartment">appartment</option>
        <option value="house">house</option>
      </select>
      <button id="applyFilters" class="small">Применить</button>
      <button id="clearFilters" class="small">Сброс</button>
    </div>

    <div id="tableWrap">
      <table id="aptTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Тип</th>
            <th>Комнат</th>
            <th>Площадь</th>
            <th>Этаж</th>
            <th>Отделка</th>
            <th>Адрес</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="empty">Загрузка...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8008/'; // или http://web:8008/ в docker
    const tbody = document.getElementById('tbody');
    const refreshBtn = document.getElementById('refreshBtn');
    const filterRooms = document.getElementById('filterRooms');
    const filterFloor = document.getElementById('filterFloor');
    const filterArea = document.getElementById('filterArea');
    const filterType = document.getElementById('filterType');
    const applyFilters = document.getElementById('applyFilters');
    const clearFilters = document.getElementById('clearFilters');

    const newType = document.getElementById('newType');
    const newRooms = document.getElementById('newRooms');
    const newArea = document.getElementById('newArea');
    const newFloor = document.getElementById('newFloor');
    const newImprovement = document.getElementById('newImprovement');
    const newAddress = document.getElementById('newAddress');
    const createBtn = document.getElementById('createBtn');

    async function fetchList(params = {}) {
      try {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'Загрузка...';
        const url = new URL(API_BASE);
        Object.entries(params).forEach(([k,v]) => {
          if (v !== null && v !== undefined && v !== '') url.searchParams.set(k, v);
        });
        const resp = await fetch(url.toString());
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        renderTable(data);
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="8" class="empty">Ошибка: ${escapeHtml(err.message)}</td></tr>`;
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'Обновить';
      }
    }

    function renderTable(list) {
      if (!Array.isArray(list) || list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="empty">Ничего не найдено</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(item => {
        return `<tr>
          <td class="center">${escapeHtml(String(item.id ?? ''))}</td>
          <td>${escapeHtml(String(item.appartment_type ?? ''))}</td>
          <td class="center">${escapeHtml(String(item.num_rooms ?? ''))}</td>
          <td class="center">${(item.floor_area !== undefined && item.floor_area !== null) ? escapeHtml(String(item.floor_area) + ' м²') : ''}</td>
          <td class="center">${escapeHtml(String(item.floor ?? ''))}</td>
          <td class="center">${escapeHtml(String(item.improvement ?? ''))}</td>
          <td>${escapeHtml(String(item.address ?? ''))}</td>
          <td class="center">
            <button class="deleteBtn" onclick="deleteItem(${item.id})">Удалить</button>
          </td>
        </tr>`;
      }).join('');
    }

    async function deleteItem(id) {
      if (!confirm(`Удалить квартиру ID=${id}?`)) return;
      try {
        const resp = await fetch(`${API_BASE}${id}`, { method: 'DELETE' });
        if (!resp.ok && resp.status !== 204) throw new Error(`HTTP ${resp.status}`);
        fetchCurrentFilters();
      } catch (err) {
        alert('Ошибка удаления: ' + err.message);
      }
    }

    async function createItem() {
      const payload = {
        appartment_type: newType.value,
        num_rooms: parseInt(newRooms.value),
        floor_area: parseFloat(newArea.value),
        floor: parseInt(newFloor.value),
        improvement: newImprovement.value,
        address: newAddress.value
      };
      try {
        const resp = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        // очищаем форму
        newType.value = '';
        newRooms.value = '';
        newArea.value = '';
        newFloor.value = '';
        newImprovement.value = '';
        newAddress.value = '';
        fetchCurrentFilters(); // обновляем таблицу
      } catch (err) {
        alert('Ошибка создания: ' + err.message);
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    refreshBtn.addEventListener('click', () => fetchCurrentFilters());
    applyFilters.addEventListener('click', () => fetchCurrentFilters());
    clearFilters.addEventListener('click', () => {
      filterRooms.value = '';
      filterFloor.value = '';
      filterArea.value = '';
      filterType.value = '';
      fetchList();
    });
    createBtn.addEventListener('click', () => createItem());

    function fetchCurrentFilters() {
      const params = {};
      if (filterRooms.value) params.num_rooms = filterRooms.value;
      if (filterFloor.value) params.floor = filterFloor.value;
      if (filterArea.value) params.floor_area = filterArea.value;
      if (filterType.value) params.appartment_type = filterType.value;
      fetchList(params);
    }

    fetchList();
  </script>
</body>
</html>
